{{ define "main" }}

<div class="mb-4">
    {{ .Content }}
</div>

<!-- The following block is executed only if required publications config is set in the hugo.yaml config file -->
{{ if and .Site.Params.publications.country .Site.Params.publications.query_list }}
{{ $category_display := .Site.Params.publications.category_display }}
<div class="container">
    <div class="row">
        {{ if eq $category_display "dropdown" }}
        <div class="p-0 mb-2">
            <strong>Categories: </strong>
            <div id="pub-categories-select" class="d-inline-block"></div>
        </div>
        {{ else }}
        <div class="col-lg-2 px-0 mb-2">
            <div class="pb-3 bg-light">
                <h5 class="px-3 py-2" style="background-color: #d8d8d8;">Categories</h5>
                <div id="pub-categories-list" class="px-3"></div>
            </div>
        </div>
        {{ end }}
        <div class="col-lg px-0 mt-2{{ if ne $category_display "dropdown" }} ms-lg-3{{ end }}">
            <!-- Loading indicator -->
            <div id="pubs-loading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-aqua" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading publications...</span>
                </div>
                <p class="mt-3 text-muted">Loading publications...</p>
            </div>
            <div id="publications-list" class="table-responsive">
            </div>
        </div>
    </div>
</div>

<script>
    // query list set in hugo config file
    const queryList = {
            {{ range $k, $v := .Site.Params.publications.query_list }}
            '{{ $k }}': '{{ $v }} AND AFF:"{{ $.Site.Params.publications.country }}"',
            {{ end }}
    }

    // compile and return relavant query URL
    function getQueryURL(pubCat, type="web", pastYear=false) {
        const europePMCWebURL = "https://europepmc.org/search?";
        const europePMCRestURL = "https://www.ebi.ac.uk/europepmc/webservices/rest/search?sortBy=FIRST_PDATE_D+desc&resultType=core&format=json&pageSize=10&";
        const europePMCBaseURL = type === "web" ? europePMCWebURL : europePMCRestURL;
        const query = pastYear ? `${queryList[pubCat]} AND FIRST_PDATE:[${getQueryYear()}]` : queryList[pubCat];
        return `${europePMCBaseURL}query=${encodeURIComponent(query)}`
    }

    // Get past year string to add to query
    function getQueryYear() {
        const date = new Date();
        const currentYear = date.getFullYear();
        const currentMonth = ("0" + (date.getMonth() + 1)).slice(-2);
        return `${currentYear - 1}-${currentMonth} TO ${currentYear}-${currentMonth}`;
    }

    // Function to fetch data from Europe PMC
    async function fetchPubs(queryKey) {
        const apiQueryURL = getQueryURL(queryKey, "rest", true);
        // If cache not older than a hour exists, use cached data
        if ('caches' in window) {
            const cache = await caches.open('pathogens-portal-node');
            const cachedResponse = await cache.match(apiQueryURL);
            if (cachedResponse && cachedResponse.headers.get('timestamp') > Date.now() - 60 * 60 * 1000) {
                const data = await cachedResponse.json();
                return data?.resultList?.result
            } else {
                await cache.delete(apiQueryURL);
            }
        }
        // Fetch data if cache doesn't exist of older than 24 hours
        const response = await fetch(apiQueryURL);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        if ('caches' in window) {
            const cache = await caches.open('pathogens-portal-node');
            await cache.put(apiQueryURL, new Response(JSON.stringify(data), {
                headers: {
                    'Content-Type': 'application/json',
                    'timestamp': Date.now()
                }
            }));
        }
        return data?.resultList?.result
    }

    // Display loader
    function loaderWheel(show) {
        const loader = document.getElementById("pubs-loading");
        loader.style.display = show ? "block" : "none";
    }

    // Function to render HTML for the publications
    async function renderTable(pubCat) {
        // Hide any current active table or messages
        const activeTables = document.querySelectorAll("#publications-list div.pub-table.active");
        activeTables.length && activeTables.forEach(tb => tb.classList.remove("active"));
        const noPubText = document.getElementById("no-pub-text");
        noPubText && noPubText.remove();

        loaderWheel(true);

        const catID = pubCat.toLowerCase().replace(" ", "-");
        const tableDivID = catID + '-publications';
        const tableID = catID + '-table';
        let pubTableDiv = document.getElementById(tableDivID);
        if (pubTableDiv) {
            pubTableDiv.classList.add("active");
        } else {
            const pubContainer = document.getElementById("publications-list");
            const data = await fetchPubs(pubCat);
            if (data.length) {
                const tableDiv = document.createElement("div");
                tableDiv.id = tableDivID;
                tableDiv.classList.add("pub-table", "active");

                const textDiv = document.createElement("div");
                textDiv.classList.add("pb-3");
                textDiv.innerHTML = `Below are the 10 most recent national publications for <code style="text-transform: capitalize">
                                    ${pubCat}</code>, to see more please visit 
                                    <a target="_bank" href="${getQueryURL(pubCat)}">Europe PMC</a>`;
                tableDiv.appendChild(textDiv);

                const table = document.createElement("table");
                table.id = tableID;
                table.classList.add("table", "table-hover");

                const thead = document.createElement("thead");
                thead.classList.add("table-light");
                const tbody = document.createElement("tbody");
                const headers = ["Publications"];
                const headerRow = document.createElement("tr");

                headers.forEach(header => {
                    const th = document.createElement("th");
                    th.textContent = header;
                    th.scope = "col";
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                data.forEach(item => {
                    const row = document.createElement("tr");
                    const publication = document.createElement("td");
                    const title = `<div><a href="https://doi.org/${item.doi}" target="_blank"><span style="font-weight:500;">${item.title}</span></a></div>`;
                    const authors = `<div><span class="text-muted" style="font-size:0.82em">${item.authorString}</span></div>`;
                    const journal = `<div><span class="text-muted" style="font-size:0.82em">${item.journalInfo?.journal?.title}</span></div>`;
                    const doi = `<div><span class="text-muted" style="font-size:0.82em">DOI: ${item.doi}</span></div>`;

                    publication.innerHTML = title + authors + journal + doi;
                    row.appendChild(publication);
                    tbody.appendChild(row);
                });

                table.appendChild(thead);
                table.appendChild(tbody);

                tableDiv.appendChild(table)
                pubContainer.appendChild(tableDiv);
            } else {
                const noPubText = document.createElement("p");
                noPubText.id = "no-pub-text";
                noPubText.style.textAlign = "center";
                noPubText.innerHTML = `Unable to retrieve publications for <code style="text-transform: capitalize">
                                        ${pubCat}</code>, please report this to the portal team.`;
                pubContainer.appendChild(noPubText);
            }
        }
        loaderWheel(false);
    }

    {{ if eq $category_display "dropdown" }}
    // Function to select categories
    async function addCategoriesSelector(parentDivID) {
        let activeCategory;
        const parentDiv = document.getElementById(parentDivID);
        const catSelect = document.createElement("select");
        catSelect.id = "pubcat-selector";
        catSelect.classList.add("form-select");
        catSelect.ariaLabel = "Select publication category";
        catSelect.onchange = async (e) => {
            const pubCat = e.target.value;
            pubCat && await renderTable(pubCat);
        };
        Object.keys(queryList).forEach((key, index) => {
            const catID = key.toLowerCase().replace(" ", "-");
            const catOption = document.createElement("option");
            catOption.value = key;
            catOption.style.textTransform = "capitalize";
            catOption.textContent = key;
            if (index === 0) {
                catOption.selected = true;
                activeCategory = key;
            }
            catSelect.appendChild(catOption);
        });
        parentDiv.appendChild(catSelect);
        return activeCategory
    }
    {{ else }}
    // Function to add data filters checkbox
    async function addCategories (parentDiv) {
        let activeCategory;
        const pubCat = document.getElementById(parentDiv);
        const catNav = document.createElement("nav");
        Object.keys(queryList).forEach((key, index) => {
            const catID = key.toLowerCase().replace(" ", "-");
            const catDiv = document.createElement("div");
            catDiv.id = catID;
            const catSpan = document.createElement("span");
            catSpan.classList.add("nav-pub");
            if (index === 0) {
                catSpan.classList.add("active");
                activeCategory = key;
            }
            catSpan.textContent = key;
            catSpan.onclick = async () => {
                await setCategoryActive(catID);
                await renderTable(key);
            };
            catDiv.appendChild(catSpan);
            catNav.appendChild(catDiv);
        });
        pubCat.appendChild(catNav);
        return activeCategory;
    }

    // Function to set active categories
    function setCategoryActive(catID) {
        // Remove current active status
        const activeCategories = document.querySelectorAll("#pub-categories-list span.nav-pub.active");
        activeCategories.length && activeCategories.forEach(ct => ct.classList.remove("active"));
        const catNavSpan = document.querySelector(`#pub-categories-list #${catID} span.nav-pub`);
        catNavSpan && catNavSpan.classList.add("active");
    }
    {{ end }}

    // Load the html content
    document.addEventListener("DOMContentLoaded", async () => {
        {{ if eq $category_display "dropdown" }}
        const activeCategory = await addCategoriesSelector("pub-categories-select");
        {{ else }}
        const activeCategory = await addCategories("pub-categories-list");
        {{ end }}
        await renderTable(activeCategory);
    });

</script>

{{ end }}

{{ end }}
